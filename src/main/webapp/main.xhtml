<!DOCTYPE html>
<html lang="en"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:ace="http://www.icefaces.org/icefaces/components"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:h="http://xmlns.jcp.org/jsf/html">
    <h:head>
        <title>Main page</title>
        <h:outputScript library="js" name="Graph.js" target="head"/>
        <h:outputScript library="js" name="script.js" target="head"/>
    </h:head>
    <h:body>
        <h:link outcome="index" value="Стартовая страница" />
        <h:panelGrid columns="2">
            <canvas id="myCanvas" width="400" height="400"></canvas>
            <h:form id="mainForm">
                <h:outputLabel for="X" value="Координата X:" />
                <ace:sliderEntry stepPercent="25" id="X" value="#{rowBean.x}" min="-2" max="2" length="200" showLabels="true">
                    <ace:ajax render="xValue" event="slide" execute="X"/>
                </ace:sliderEntry>                
                <h:outputText id="xValue" value="${rowBean.x}"/>
                <br/>
                <h:outputLabel for="Y" value="Координата Y:" />
                <h:inputText autocomplete="off" id="Y" value="#{rowBean.y}">
                    <ace:ajax render="latestRequest Y" execute="Y"/>
                </h:inputText>
                <br/>
                <h:message for="Y"/>
                <br/>
                <h:outputLabel for="R" value="Коэффициент R: " />
                <ace:sliderEntry onSlide="redraw()" onSlideEnd="redraw()" id="R" value="#{rowBean.integerR}" min="200" max="500" stepPercent="8.33333333" length="200">
                    <ace:ajax event="slide" render="rValue" execute="R" />
                </ace:sliderEntry>                
                <h:outputText id="rValue" value="${rowBean.r}" />
                <br />
                <h:commandButton onclick="redraw()" value="Проверить" id="button"  >
                    <ace:ajax render=":resultTable latestRequest" execute="X Y R"/> 
                    <f:actionListener binding="#{rowBean.process()}" />
                </h:commandButton> 
                <h:outputText id="latestRequest" value="Latest request: ${rowBean.x} ${rowBean.y} ${rowBean.r} ${rowBean.result}"/>
            </h:form>
        </h:panelGrid> 
        <h:form id="hiddenForm">
            <h:inputHidden id="X" value="#{rowBean.x}"/>
            <h:inputHidden id="Y" value="#{rowBean.y}"/>
            <h:inputHidden id="Y" value="#{rowBean.r}"/>
            <h:commandButton id="hiddenButton" onclick="redraw()" style="display: none;">
                <f:ajax render="mainForm:latestRequest :resultTable" execute="X Y R"/>
                <f:actionListener binding="#{rowBean.process()}"/>
            </h:commandButton>
        </h:form>
        <h:panelGroup id="resultTable">
            <h:form>
                <h:commandButton onclick="redraw()" value="Очистить результаты">
                    <f:actionListener binding="#{tableBean.removeSession()}"/>
                    <ace:ajax render=":resultTable"/>
                </h:commandButton>
            </h:form>
            <h:dataTable value="${tableBean.list}" var="rowBean" rendered="#{tableBean.list.size() != 0}">
                <h:column>
                    <f:facet name="header">X</f:facet>
                    ${rowBean.x}
                </h:column>
                <h:column>
                    <f:facet name="header">Y</f:facet>
                    ${rowBean.y}
                </h:column>
                <h:column>
                    <f:facet name="header">R</f:facet>
                    ${rowBean.r}
                </h:column>
                <h:column>
                    <f:facet name="header">Result</f:facet>
                    ${rowBean.result ? "Принадлежит!":"Не принадлежит!"}
                </h:column>
            </h:dataTable>
        </h:panelGroup>
        <h:outputScript target="body">
            const canvasId = "myCanvas";
            const yId = "hiddenForm:Y";
            const xId = "hiddenForm:X";
            const rValueId = "mainForm:rValue";
            const buttonId = "hiddenForm:hiddenButton";
            const myGraph = new Graph({
                canvasId: canvasId,
                minX: -3,
                minY: -6,
                maxX: 3,
                maxY: 6,
                unitsPerTick: 1
            });
            myGraph.canvas.addEventListener("click", function (evt) {
                    var answer = myGraph.getClickCoords(evt);
                    document.getElementById(xId).value = answer.x;
                    document.getElementById(yId).value = answer.y;
                    document.getElementById(buttonId).click();
                }
            );
            function redraw() {
                draw(rValueId, myGraph);
                const points = #{tableBean.listAsJson};
                for (let i = 0; i &lt; points.length; i++) {
                    const point = points[i];
                    drawAPoint(point.X, point.Y, point.result, myGraph);
                }
            }
            redraw();
        </h:outputScript>
    </h:body>
</html>
